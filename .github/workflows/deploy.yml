name: Ticketing Deployment
on:
  push:
    branches:
      - main
      - dev
env:
  CACHE_KEY: node-deps
  MONGODB_DB_NAME: gha-demo
jobs:
  deploy:
    name: 'Deploy Bundle'
    runs-on: ubuntu-latest
    steps:
      - name: Set environment for branch
        run: |
          if [[ $GITHUB_REF_NAME == 'main' ]]; then
              echo "DATABRICKS_BUNDLE_ENV=prod" >> "$GITHUB_ENV"
          elif [[ $GITHUB_REF_NAME == 'staging' ]]; then
              echo "DATABRICKS_BUNDLE_ENV=staging" >> "$GITHUB_ENV"
          elif [[ $GITHUB_REF_NAME == 'test' ]]; then
              echo "DATABRICKS_BUNDLE_ENV=test" >> "$GITHUB_ENV"
          elif [[ $GITHUB_REF_NAME == 'dev' ]]; then
              echo "DATABRICKS_BUNDLE_ENV=dev" >> "$GITHUB_ENV"
          fi
      - name: Get Code
        uses: actions/checkout@v3
      - name: Setup cli
        uses: databricks/setup-cli@main
      - run: databricks bundle deploy
        working-directory: .
        env:
          DATABRICKS_TOKEN: ${{ secrets.SP_TOKEN }}
          DATABRICKS_BUNDLE_ENV: ${DATABRICKS_BUNDLE_ENV}
