name: Ticketing Deployment
on:
  push:
    branches:
      - main
      - dev
# env:
#   CACHE_KEY: node-deps
#   MONGODB_DB_NAME: gha-demo
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: 'Deploy Bundle'
    runs-on: ubuntu-latest
    steps:
      - name: Set environment for branch
        run: |
          if [[ $GITHUB_REF_NAME == 'main' ]]; then
              echo "DATABRICKS_BUNDLE_ENV=prod" >> "$GITHUB_ENV"
          elif [[ $GITHUB_REF_NAME == 'staging' ]]; then
              echo "DATABRICKS_BUNDLE_ENV=staging" >> "$GITHUB_ENV"
          elif [[ $GITHUB_REF_NAME == 'test' ]]; then
              echo "DATABRICKS_BUNDLE_ENV=test" >> "$GITHUB_ENV"
          elif [[ $GITHUB_REF_NAME == 'dev' ]]; then
              echo "DATABRICKS_BUNDLE_ENV=dev" >> "$GITHUB_ENV"
          fi
      - name: Get Code
        uses: actions/checkout@v3

      # - name: Azure Login
      #   uses: azure/login@v2
      #   with:
      #     creds: ${{ secrets.AZURE_CREDENTIALS }}

      # - name: Azure CLI script
      #   uses: azure/cli@v2
      #   with:
      #     azcliversion: latest
      #     inlineScript: |
      #       az account show

      - name: Setup cli
        uses: databricks/setup-cli@main
      - run: databricks bundle deploy
        working-directory: .
        env:
          DATABRICKS_CLIENT_SECRET: ${{ secrets.SP_TOKEN }}
          DATABRICKS_CLIENT_ID: 0a49a47b-e012-42c9-a1b9-8aab449a9a7e
          DATABRICKS_BUNDLE_ENV: ${{ env.DATABRICKS_BUNDLE_ENV }}
